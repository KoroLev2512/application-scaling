# Устранение проблем с деплоем

## Ошибка: "Connection timed out" на порту 22

Эта ошибка означает, что GitHub Actions не может подключиться к вашему серверу по SSH.

### Возможные причины и решения:

#### 1. Сервер недоступен из интернета

**Проблема:** Сервер находится за NAT или в локальной сети и недоступен из интернета.

**Решения:**
- Используйте сервер с публичным IP адресом
- Настройте VPN или туннель для доступа к серверу
- Используйте облачный сервер (AWS, DigitalOcean, Hetzner, etc.)

#### 2. Файрвол блокирует порт 22

**Проблема:** Файрвол на сервере или у провайдера блокирует SSH порт.

**Проверка:**
```bash
# На сервере проверьте, слушает ли SSH
sudo netstat -tlnp | grep :22
# или
sudo ss -tlnp | grep :22

# Проверьте файрвол
sudo ufw status
# или
sudo iptables -L -n
```

**Решение:**
```bash
# Разрешите SSH в файрволе
sudo ufw allow 22/tcp
sudo ufw reload

# Или для iptables
sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT
```

#### 3. SSH использует другой порт

**Проблема:** SSH настроен на нестандартный порт (не 22).

**Решение:**
Добавьте секрет `SSH_PORT` в GitHub:
- Имя: `SSH_PORT`
- Значение: номер порта (например: `2222`, `2200`)

#### 4. Сервер не запущен или SSH не работает

**Проверка на сервере:**
```bash
# Проверьте статус SSH сервиса
sudo systemctl status ssh
# или
sudo systemctl status sshd

# Если не запущен, запустите
sudo systemctl start ssh
sudo systemctl enable ssh
```

#### 5. Неправильный IP адрес

**Проблема:** В секрете `SERVER_IP` указан неправильный адрес.

**Проверка:**
```bash
# На сервере узнайте публичный IP
curl ifconfig.me
# или
curl ipinfo.io/ip

# Проверьте, что IP правильный
ping ВАШ_IP
```

#### 6. Провайдер блокирует входящие соединения

**Проблема:** Некоторые провайдеры блокируют входящие соединения на порт 22.

**Решения:**
- Используйте другой порт для SSH (например, 2222)
- Обратитесь к провайдеру для разблокировки
- Используйте облачного провайдера

### Диагностика подключения

#### Проверка с вашего компьютера:

```bash
# Проверьте доступность сервера
ping ВАШ_IP

# Проверьте доступность порта SSH
telnet ВАШ_IP 22
# или
nc -zv ВАШ_IP 22

# Попробуйте подключиться по SSH
ssh -v ВАШ_ПОЛЬЗОВАТЕЛЬ@ВАШ_IP
```

#### Проверка на сервере:

```bash
# Проверьте, что SSH слушает правильный порт
sudo netstat -tlnp | grep ssh
sudo ss -tlnp | grep ssh

# Проверьте логи SSH
sudo tail -f /var/log/auth.log
# или
sudo journalctl -u ssh -f
```

### Альтернативные решения

#### Вариант 1: Использование GitHub Actions Self-hosted Runner

Если сервер недоступен из интернета, можно установить self-hosted runner на сервере:

1. В GitHub: Settings → Actions → Runners → New self-hosted runner
2. Следуйте инструкциям для установки runner на сервере
3. Измените workflow, чтобы он использовал `runs-on: self-hosted`

#### Вариант 2: Использование webhook

Вместо прямого SSH подключения можно использовать webhook:

1. На сервере создайте endpoint, который будет принимать webhook от GitHub
2. При получении webhook выполните `git pull` и `docker-compose up -d`
3. Используйте GitHub Actions для отправки webhook

#### Вариант 3: Использование Docker Hub / GitHub Container Registry

1. Соберите образ в GitHub Actions
2. Запушьте в Docker Hub или GHCR
3. На сервере используйте cron job для периодического `docker-compose pull && docker-compose up -d`

### Проверка конфигурации секретов

Убедитесь, что все секреты настроены правильно:

- ✅ `SSH_PRIVATE_KEY` - приватный SSH ключ
- ✅ `SERVER_USER` - имя пользователя (например: `root`, `ubuntu`)
- ✅ `SERVER_IP` - публичный IP адрес или домен
- ✅ `DEPLOY_PATH` - путь на сервере
- ⚠️ `SSH_PORT` - порт SSH (опционально, по умолчанию 22)
- ⚠️ `SSH_KNOWN_HOSTS` - fingerprint сервера (опционально)

### Тестирование подключения

После настройки секретов, проверьте подключение вручную:

```bash
# Используя ключ из GitHub Actions
ssh -i ~/.ssh/github_actions -p 22 ВАШ_ПОЛЬЗОВАТЕЛЬ@ВАШ_IP
```

Если подключение работает вручную, но не работает в GitHub Actions, проверьте:
- Правильность скопированного приватного ключа (должен включать BEGIN и END)
- Правильность настроенных секретов (регистр важен)
